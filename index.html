<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>MATHビューア v2.5 (静的ファイル対応)</title>
<style>
    /* CSSはv2.3から変更ありません */
    body { font-family: sans-serif; line-height: 1.7; padding: 20px; background-color: #f0f2f5; }
    .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    h1, h2, h3 { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
    h1 { border-width: 2px; border-color: #4a90e2;}
    .file-loader, .search-area { margin-bottom: 25px; padding: 20px; border-radius: 5px; background-color: #f9f9f9; }
    #problem-display { border: 1px solid #ddd; padding: 20px; border-radius: 5px; }
    .block { margin-bottom: 1.5em; }
    .title_block { font-size: 1.2em; font-weight: bold; color: #333; margin-top: 2em; }
    .title_block.section_title { font-size: 1.4em; color: #4a90e2; border-bottom: 2px solid #4a90e2; padding-bottom: 5px; margin-top: 2.5em; }
    .title_block.section_title:first-child { margin-top: 0; }
    .text_block { white-space: pre-wrap; }
    .options_block ul { list-style-type: none; padding-left: 0; }
    .options_block li { margin-bottom: 0.5em; }
    .image-container { display: flex; flex-wrap: wrap; gap: 15px; }
    .image-container img { max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; }
    .text_block.statement   { background-color: #fffbe6; border-left: 5px solid #ffc107; padding: 15px; border-radius: 4px; }
    .text_block.explanation { background-color: #e3f2fd; border-left: 5px solid #2196f3; padding: 15px; border-radius: 4px; }
    .text_block.notice      { background-color: #ffebee; border-left: 5px solid #f44336; padding: 15px; border-radius: 4px; }
    .text_block.success     { background-color: #e8f5e9; border-left: 5px solid #4caf50; padding: 15px; border-radius: 4px; }
    .text_block.muted       { background-color: #f5f5f5; border-left: 5px solid #9e9e9e; padding: 15px; border-radius: 4px; }
    .text_block.normal      { padding: 0; }
    .id-button { margin: 3px; padding: 5px 10px; cursor: pointer; }
</style>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div class="container">
        <h1>MATHビューア v2.5</h1>
        <div class="file-loader">
            <h2>問題セットを選択</h2>
            <div id="problem-set-buttons"></div>
        </div>
        <div id="search-container" style="display: none;">
            <p>ファイル内の問題リスト:</p>
            <div id="id-buttons-container"></div>
        </div>
        <div id="problem-display"><p>マニフェストを読み込んでいます...</p></div>
    </div>
<script>
let problemsInFile = []; // ファイル内の問題を保持する配列

document.addEventListener('DOMContentLoaded', loadManifest);

async function loadManifest() {
    try {
        const response = await fetch('manifest.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const manifest = await response.json();
        const container = document.getElementById('problem-set-buttons');
        if (manifest.problems && container) {
            container.innerHTML = manifest.problems.map(problemSet => 
                `<button class="id-button" onclick="loadProblemFile('${problemSet.path}')">${escapeHtml(problemSet.name)}</button>`
            ).join('');
            document.getElementById('problem-display').innerHTML = '<p>問題セットを選択してください。</p>';
        } else {
             throw new Error("manifest.json is missing 'problems' array or button container not found.");
        }
    } catch (error) {
        document.getElementById('problem-display').innerHTML = `<p style="color:red;">マニフェストファイルの読み込みに失敗しました: ${error.message}</p>`;
        console.error("Failed to load manifest:", error);
    }
}

async function loadProblemFile(path) {
    document.getElementById('problem-display').innerHTML = '<p>読み込み中...</p>';
    document.getElementById('search-container').style.display = 'none';
    document.getElementById('id-buttons-container').innerHTML = '';

    try {
        const response = await fetch(path);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        problemsInFile = await response.json();
        
        if (!Array.isArray(problemsInFile)) {
            throw new Error("JSON is not an array.");
        }
        document.getElementById('search-container').style.display = 'block';
        displayIdButtons();

        if (problemsInFile.length === 1) {
            displayProblem(0);
        } else {
            document.getElementById('problem-display').innerHTML = '<p>表示する問題を選択してください。</p>';
        }
    } catch (error) {
        document.getElementById('problem-display').innerHTML = `<p style="color:red;">問題ファイル[${path}]の読み込みエラー: ${error.message}</p>`;
        console.error("Failed to load problem file:", error);
    }
}

function displayIdButtons() {
    const container = document.getElementById('id-buttons-container');
    container.innerHTML = problemsInFile.map((p, index) => 
        `<button class="id-button" onclick="displayProblem(${index})">${p.problem_id || `(無題 ${index+1})`}</button>`
    ).join('');
}

function displayProblem(index) {
    const p = problemsInFile[index];
    const displayArea = document.getElementById('problem-display');
    if (p && p.problem_flow) {
        let html = `<h3>${p.problem_id || ''}</h3>`;
        html += p.problem_flow.map(renderBlock).join('');
        displayArea.innerHTML = html;
    } else {
        displayArea.innerHTML = `<p style="color:red;">選択された問題の形式が正しくありません。</p>`;
    }
}

function renderBlock(block) {
    let contentHtml = '';
    const blockClass = block.class ? ` ${block.class}` : '';
    switch (block.type) {
        case 'title_block': contentHtml = escapeHtml(block.content); break;
        case 'text_block': contentHtml = `<div class="${block.class || 'normal'}">${escapeHtml(block.content)}</div>`; break;
        case 'image_gallery': contentHtml = `<div class="image-container">${(block.paths || []).map(path => `<img src="${path}" alt="図">`).join('')}</div>`; break;
        case 'options_block':
            const title = block.title ? `<strong>${escapeHtml(block.title)}</strong>` : '';
            const options = (block.options || []).map(opt => `<li><strong>${opt.label || ''}.</strong> ${escapeHtml(opt.value || '')}</li>`).join('');
            contentHtml = `${title}<ul>${options}</ul>`;
            break;
    }
    return `<div class="block ${block.type}${blockClass}">${contentHtml}</div>`;
}

function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
}
</script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
